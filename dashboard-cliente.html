<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodFlow - √Årea do Cliente</title>
    <style>
        /* [MANTENHA TODO O CSS ANTERIOR] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .user-email {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .search-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .search-box {
            background: white;
            border-radius: 50px;
            padding: 15px 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-box input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 1rem;
            background: transparent;
        }

        .cart-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .cart-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .search-filters {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: white;
            border: 2px solid #e1e5e9;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .nav-tabs {
            background: white;
            border-bottom: 2px solid #e9ecef;
            padding: 0 20px;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
        }

        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab.active {
            border-bottom-color: #007bff;
            color: #007bff;
        }

        .nav-tab:hover {
            background: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-title {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #333;
        }

        .lojas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .loja-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .loja-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .loja-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .loja-nome {
            font-size: 1.3rem;
            font-weight: 600;
            color: #007bff;
        }

        .loja-categoria {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .loja-descricao {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .loja-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
        }

        .produtos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .produto-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .produto-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .produto-nome {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .produto-descricao {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.4;
            font-size: 0.9rem;
        }

        .produto-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .produto-preco {
            font-size: 1.3rem;
            font-weight: 700;
            color: #28a745;
        }

        .btn-add-cart {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-add-cart:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .carrinho-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .carrinho-items {
            margin-bottom: 20px;
        }

        .carrinho-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .carrinho-item:last-child {
            border-bottom: none;
        }

        .item-info {
            flex: 1;
        }

        .item-nome {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .item-preco {
            color: #28a745;
            font-weight: 600;
        }

        .item-quantidade {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-quantidade {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .btn-quantidade:hover {
            background: #e9ecef;
        }

        .carrinho-total {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .total-valor {
            font-size: 1.5rem;
            font-weight: 700;
            color: #28a745;
            margin: 10px 0;
        }

        .btn-finalizar {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-finalizar:hover {
            background: #1e7e34;
            transform: translateY(-2px);
        }

        .pedidos-lista {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .pedido-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .pedido-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .pedido-id {
            font-weight: 600;
            color: #007bff;
        }

        .pedido-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pendente { background: #fff3cd; color: #856404; }
        .status-preparando { background: #cce7ff; color: #004085; }
        .status-em-entrega { background: #d1ecf1; color: #0c5460; }
        .status-entregue { background: #d4edda; color: #155724; }
        .status-pago { background: #d4edda; color: #155724; }

        .pedido-total {
            font-weight: 600;
            color: #28a745;
            text-align: right;
            margin-top: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .pagamento-container {
            text-align: center;
            padding: 20px;
        }

        .pagamento-total {
            font-size: 1.8rem;
            font-weight: 700;
            color: #28a745;
            margin: 20px 0;
        }

        .btn-mercado-pago {
            width: 100%;
            padding: 15px;
            background: #00b1ea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .btn-mercado-pago:hover {
            background: #0098ce;
            transform: translateY(-2px);
        }

        .btn-teste {
            width: 100%;
            padding: 15px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-teste:hover {
            background: #545b62;
        }

        .info-teste {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .user-info {
                text-align: center;
            }

            .nav-container {
                flex-wrap: wrap;
            }

            .nav-tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .lojas-grid,
            .produtos-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 10px;
                max-height: 95vh;
            }
        }
    </style>
</head>
<body>
    <!-- Cabe√ßalho -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <h1>üçî FoodFlow</h1>
                <div>√Årea do Cliente</div>
            </div>
            <div class="user-info">
                <div class="user-name" id="userName">Cliente FoodFlow</div>
                <div class="user-email" id="userEmail">cliente@foodflow.com</div>
            </div>
        </div>
    </div>

    <!-- Busca -->
    <div class="search-container">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="üîç Buscar restaurantes ou produtos...">
            <button class="cart-btn" onclick="toggleCarrinho()">
                üõí Carrinho (<span id="cartCount">0</span>)
            </button>
        </div>
        <div class="search-filters">
            <button class="filter-btn active" onclick="filtrarLojas('todos')">Todos</button>
            <button class="filter-btn" onclick="filtrarLojas('restaurante')">üçΩÔ∏è Restaurantes</button>
            <button class="filter-btn" onclick="filtrarLojas('lanchonete')">üçî Lanchonetes</button>
            <button class="filter-btn" onclick="filtrarLojas('pizzaria')">üçï Pizzarias</button>
            <button class="filter-btn" onclick="filtrarLojas('mercado')">üõí Mercados</button>
        </div>
    </div>

    <!-- Navega√ß√£o -->
    <div class="nav-tabs">
        <div class="nav-container">
            <div class="nav-tab active" onclick="abrirTab('lojas')">üè™ Lojas</div>
            <div class="nav-tab" onclick="abrirTab('carrinho')">üõí Carrinho</div>
            <div class="nav-tab" onclick="abrirTab('pedidos')">üì¶ Meus Pedidos</div>
            <div class="nav-tab" onclick="abrirTab('perfil')">üë§ Meu Perfil</div>
        </div>
    </div>

    <!-- Conte√∫do Principal -->
    <div class="container">
        <!-- Aba: Lojas -->
        <div id="lojas" class="tab-content active">
            <h2 class="page-title">üçΩÔ∏è Lojas Dispon√≠veis</h2>
            <div class="lojas-grid" id="lojasGrid">
                <!-- Lojas carregadas via JavaScript -->
            </div>
        </div>

        <!-- Aba: Carrinho -->
        <div id="carrinho" class="tab-content">
            <h2 class="page-title">üõí Meu Carrinho</h2>
            <div class="carrinho-container">
                <div class="carrinho-items" id="carrinhoItems">
                    <div class="empty-state">
                        <div>üõí</div>
                        <h3>Carrinho vazio</h3>
                        <p>Adicione produtos das lojas para ver aqui</p>
                    </div>
                </div>
                
                <div class="carrinho-total" id="carrinhoTotal" style="display: none;">
                    <h3>Total do Pedido</h3>
                    <div class="total-valor" id="totalValor">R$ 0,00</div>
                    <button class="btn-finalizar" onclick="abrirModalPagamento()">
                        üí≥ Finalizar Pedido
                    </button>
                </div>
            </div>
        </div>

        <!-- Aba: Pedidos -->
        <div id="pedidos" class="tab-content">
            <h2 class="page-title">üì¶ Meus Pedidos</h2>
            <div class="pedidos-lista" id="pedidosLista">
                <div class="empty-state">
                    <div>üì¶</div>
                    <h3>Nenhum pedido ainda</h3>
                    <p>Seus pedidos aparecer√£o aqui</p>
                </div>
            </div>
        </div>

        <!-- Aba: Perfil -->
        <div id="perfil" class="tab-content">
            <h2 class="page-title">üë§ Meu Perfil</h2>
            <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div style="margin-bottom: 15px;">
                    <strong>Nome:</strong> <span id="perfilNome">Cliente FoodFlow</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>E-mail:</strong> <span id="perfilEmail">cliente@foodflow.com</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>Telefone:</strong> <span id="perfilTelefone">(11) 99999-9999</span>
                </div>
                <div style="margin-bottom: 20px;">
                    <strong>Endere√ßo:</strong> <span id="perfilEndereco">Rua Exemplo, 123 - S√£o Paulo, SP</span>
                </div>
                <button class="btn-finalizar" style="background: #007bff;" onclick="editarPerfil()">
                    ‚úèÔ∏è Editar Perfil
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Produtos da Loja -->
    <div class="modal" id="modalLoja">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalLojaTitulo">üçΩÔ∏è Produtos da Loja</div>
                <button class="close-modal" onclick="fecharModalLoja()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="produtos-grid" id="produtosLoja">
                    <!-- Produtos da loja carregados via JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Pagamento -->
    <div class="modal" id="modalPagamento">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üí≥ Finalizar Pagamento</div>
                <button class="close-modal" onclick="fecharModalPagamento()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="pagamento-container">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üí∞</div>
                    <h3 style="margin-bottom: 10px;">Pagamento do Pedido</h3>
                    <div class="pagamento-total" id="pagamentoTotal">R$ 0,00</div>
                    
                    <button class="btn-mercado-pago" onclick="iniciarPagamentoMercadoPago()">
                        üîµ Pagar com Mercado Pago
                    </button>
                    
                    <button class="btn-teste" onclick="simularPagamentoAprovado()">
                        üß™ Simular Pagamento (Teste)
                    </button>

                    <div class="info-teste">
                        <strong>üí° Para testes no Mercado Pago:</strong><br>
                        ‚Ä¢ Cart√£o: 5031 4332 1540 6351<br>
                        ‚Ä¢ CVV: 123<br>
                        ‚Ä¢ Data: 11/25<br>
                        ‚Ä¢ CPF: 123.456.789-00
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Configura√ß√£o do Supabase
        const supabaseUrl = 'https://lsskaqudqvppfwfoxsih.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxzc2thcXVkcXZwcGZ3Zm94c2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDIxMzEsImV4cCI6MjA3NDgxODEzMX0.-M8bTf68RVY_kVrVyZ_BEfROLOrykauRYJzS2OnH6Fo';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Estado da aplica√ß√£o
        let lojas = [];
        let produtos = [];
        let carrinho = [];
        let lojaSelecionada = null;
        let clienteId = 1;

        // Fun√ß√µes de navega√ß√£o
        function abrirTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[onclick="abrirTab('${tabName}')"]`).classList.add('active');
        }

        // Carregar Lojas
        async function carregarLojas() {
            try {
                console.log('üîÑ Carregando lojas...');
                const { data, error } = await supabase
                    .from('lojas')
                    .select('*')
                    .eq('aberta', true)
                    .order('nome');

                if (error) {
                    console.error('‚ùå Erro ao carregar lojas:', error);
                    throw error;
                }

                lojas = data || [];
                console.log('‚úÖ Lojas carregadas:', lojas);
                renderizarLojas();

            } catch (error) {
                console.error('‚ùå Erro ao carregar lojas:', error);
                mostrarErro('lojasGrid', 'Erro ao carregar lojas. Tente novamente.');
            }
        }

        function renderizarLojas() {
            const grid = document.getElementById('lojasGrid');
            
            if (!lojas || lojas.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div>üè™</div>
                        <h3>Nenhuma loja dispon√≠vel</h3>
                        <p>As lojas aparecer√£o aqui quando estiverem abertas</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = lojas.map(loja => `
                <div class="loja-card" onclick="abrirModalLoja(${loja.id})">
                    <div class="loja-header">
                        <div class="loja-nome">${loja.nome}</div>
                        <div class="loja-categoria">${getCategoriaIcon(loja.categoria)} ${loja.categoria}</div>
                    </div>
                    <div class="loja-descricao">${loja.descricao || 'Sem descri√ß√£o'}</div>
                    <div class="loja-info">
                        <span>üìç ${loja.endereco || 'Endere√ßo n√£o informado'}</span>
                        <div class="loja-status">
                            <span class="status-aberto">‚óè</span> Aberto agora
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getCategoriaIcon(categoria) {
            const icons = {
                'restaurante': 'üçΩÔ∏è',
                'lanchonete': 'üçî',
                'pizzaria': 'üçï',
                'mercado': 'üõí',
                'outros': 'üè™'
            };
            return icons[categoria] || 'üè™';
        }

        // Carregar Produtos da Loja
        async function carregarProdutosLoja(lojaId) {
            try {
                console.log('üîÑ Carregando produtos da loja:', lojaId);
                const { data, error } = await supabase
                    .from('produtos')
                    .select('*')
                    .eq('loja_id', lojaId)
                    .eq('disponivel', true)
                    .order('nome');

                if (error) {
                    console.error('‚ùå Erro ao carregar produtos:', error);
                    throw error;
                }

                produtos = data || [];
                console.log('‚úÖ Produtos carregados:', produtos);
                renderizarProdutosLoja();

            } catch (error) {
                console.error('‚ùå Erro ao carregar produtos:', error);
                mostrarErro('produtosLoja', 'Erro ao carregar produtos da loja.');
            }
        }

        function renderizarProdutosLoja() {
            const grid = document.getElementById('produtosLoja');
            
            if (!produtos || produtos.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div>üçï</div>
                        <h3>Nenhum produto dispon√≠vel</h3>
                        <p>Esta loja ainda n√£o cadastrou produtos</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = produtos.map(produto => `
                <div class="produto-card">
                    <div class="produto-nome">${produto.nome}</div>
                    <div class="produto-descricao">${produto.descricao || 'Sem descri√ß√£o'}</div>
                    <div class="produto-footer">
                        <div class="produto-preco">R$ ${(produto.preco || 0).toFixed(2)}</div>
                        <button class="btn-add-cart" onclick="adicionarAoCarrinho(${JSON.stringify(produto).replace(/"/g, '&quot;')})">
                            ‚ûï Adicionar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Modal da Loja
        async function abrirModalLoja(lojaId) {
            const loja = lojas.find(l => l.id === lojaId);
            if (!loja) {
                alert('‚ùå Loja n√£o encontrada');
                return;
            }

            lojaSelecionada = loja;
            document.getElementById('modalLojaTitulo').textContent = `üçΩÔ∏è ${loja.nome}`;
            document.getElementById('modalLoja').classList.add('active');
            
            await carregarProdutosLoja(lojaId);
        }

        function fecharModalLoja() {
            document.getElementById('modalLoja').classList.remove('active');
            lojaSelecionada = null;
        }

        // Sistema de Carrinho
        function adicionarAoCarrinho(produto) {
            if (!lojaSelecionada) {
                alert('‚ùå Selecione uma loja primeiro');
                return;
            }

            // Verificar se o produto √© da mesma loja do carrinho
            if (carrinho.length > 0) {
                const lojaCarrinho = carrinho[0].loja_id;
                if (lojaCarrinho !== produto.loja_id) {
                    if (!confirm('‚ö†Ô∏è Seu carrinho tem produtos de outra loja. Deseja esvaziar o carrinho e adicionar este produto?')) {
                        return;
                    }
                    carrinho = [];
                }
            }

            const itemExistente = carrinho.find(item => item.id === produto.id);
            
            if (itemExistente) {
                itemExistente.quantidade += 1;
            } else {
                carrinho.push({
                    ...produto,
                    quantidade: 1,
                    loja_nome: lojaSelecionada.nome
                });
            }
            
            atualizarCarrinho();
            mostrarFeedback(`‚úÖ ${produto.nome} adicionado ao carrinho!`);
        }

        function atualizarCarrinho() {
            const cartCount = document.getElementById('cartCount');
            const cartItems = document.getElementById('carrinhoItems');
            const cartTotal = document.getElementById('carrinhoTotal');
            const totalValor = document.getElementById('totalValor');

            // Atualizar contador
            const totalItens = carrinho.reduce((total, item) => total + item.quantidade, 0);
            cartCount.textContent = totalItens;

            // Atualizar itens
            if (carrinho.length === 0) {
                cartItems.innerHTML = `
                    <div class="empty-state">
                        <div>üõí</div>
                        <h3>Carrinho vazio</h3>
                        <p>Adicione produtos das lojas para ver aqui</p>
                    </div>
                `;
                cartTotal.style.display = 'none';
            } else {
                let html = '';
                let total = 0;

                carrinho.forEach((item, index) => {
                    const subtotal = (item.preco || 0) * item.quantidade;
                    total += subtotal;
                    
                    html += `
                        <div class="carrinho-item">
                            <div class="item-info">
                                <div class="item-nome">${item.nome}</div>
                                <div class="item-preco">R$ ${subtotal.toFixed(2)}</div>
                                <small style="color: #666;">${item.loja_nome}</small>
                            </div>
                            <div class="item-quantidade">
                                <button class="btn-quantidade" onclick="alterarQuantidade(${index}, -1)">-</button>
                                <span style="min-width: 30px; text-align: center;">${item.quantidade}</span>
                                <button class="btn-quantidade" onclick="alterarQuantidade(${index}, 1)">+</button>
                                <button class="btn-quantidade" onclick="removerDoCarrinho(${index})" style="margin-left: 10px; background: #dc3545; color: white;">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });

                cartItems.innerHTML = html;
                totalValor.textContent = `R$ ${total.toFixed(2)}`;
                cartTotal.style.display = 'block';
            }
        }

        function alterarQuantidade(index, mudanca) {
            carrinho[index].quantidade += mudanca;
            
            if (carrinho[index].quantidade <= 0) {
                carrinho.splice(index, 1);
            }
            
            atualizarCarrinho();
        }

        function removerDoCarrinho(index) {
            const produtoNome = carrinho[index].nome;
            carrinho.splice(index, 1);
            atualizarCarrinho();
            mostrarFeedback(`üóëÔ∏è ${produtoNome} removido do carrinho`);
        }

        function toggleCarrinho() {
            abrirTab('carrinho');
        }

        // üîµ SISTEMA DE PAGAMENTO
        function abrirModalPagamento() {
            if (carrinho.length === 0) {
                alert('‚ùå Carrinho vazio!');
                return;
            }
            
            const total = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            document.getElementById('pagamentoTotal').textContent = `R$ ${total.toFixed(2)}`;
            document.getElementById('modalPagamento').classList.add('active');
        }

        function fecharModalPagamento() {
            document.getElementById('modalPagamento').classList.remove('active');
        }

        // üîµ PAGAMENTO COM MERCADO PAGO (SIMPLIFICADO)
        async function iniciarPagamentoMercadoPago() {
            alert('üîµ Integra√ß√£o com Mercado Pago em desenvolvimento...\n\nUsando simula√ß√£o de pagamento.');
            // Simular pagamento bem-sucedido
            setTimeout(() => {
                simularPagamentoAprovado();
            }, 2000);
        }

        // üîµ SIMULAR PAGAMENTO (VERS√ÉO CORRIGIDA)
        async function simularPagamentoAprovado() {
            if (carrinho.length === 0) {
                alert('‚ùå Carrinho vazio!');
                return;
            }

            const total = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            const lojaId = carrinho[0].loja_id;

            console.log('üîÑ Iniciando finaliza√ß√£o do pedido...');
            console.log('üì¶ Itens no carrinho:', carrinho);
            console.log('üí∞ Total:', total);
            console.log('üè™ Loja ID:', lojaId);

            try {
                // 1. Primeiro criar o pedido principal
                console.log('üìù Criando pedido principal...');
                const { data: pedido, error: pedidoError } = await supabase
                    .from('pedidos')
                    .insert([{
                        loja_id: lojaId,
                        cliente_id: clienteId,
                        total: total,
                        status: 'pago', // Come√ßa como pago na simula√ß√£o
                        endereco_entrega: document.getElementById('perfilEndereco').textContent || 'Endere√ßo padr√£o',
                        created_at: new Date().toISOString()
                    }])
                    .select();

                if (pedidoError) {
                    console.error('‚ùå Erro ao criar pedido:', pedidoError);
                    throw new Error(`Erro ao criar pedido: ${pedidoError.message}`);
                }

                console.log('‚úÖ Pedido criado:', pedido);

                const pedidoId = pedido[0].id;

                // 2. Criar itens do pedido
                console.log('üì¶ Criando itens do pedido...');
                const itensPedido = carrinho.map(item => ({
                    pedido_id: pedidoId,
                    produto_id: item.id,
                    quantidade: item.quantidade,
                    preco_unitario: item.preco,
                    subtotal: (item.preco * item.quantidade)
                }));

                console.log('üìã Itens para inserir:', itensPedido);

                const { error: itensError } = await supabase
                    .from('itens_pedido')
                    .insert(itensPedido);

                if (itensError) {
                    console.error('‚ùå Erro ao criar itens do pedido:', itensError);
                    
                    // Se der erro nos itens, deletar o pedido criado
                    await supabase.from('pedidos').delete().eq('id', pedidoId);
                    throw new Error(`Erro ao adicionar itens: ${itensError.message}`);
                }

                console.log('‚úÖ Itens do pedido criados com sucesso');

                // 3. Limpar carrinho e mostrar sucesso
                carrinho = [];
                atualizarCarrinho();
                fecharModalPagamento();
                
                // 4. Atualizar lista de pedidos
                await carregarPedidos();
                
                // 5. Mostrar mensagem de sucesso
                alert(`üéâ Pedido #${pedidoId} realizado com sucesso!\n\nüí∞ Total: R$ ${total.toFixed(2)}\n\nAcompanhe o status na aba "Meus Pedidos".`);

            } catch (error) {
                console.error('‚ùå Erro ao finalizar pedido:', error);
                
                let mensagemErro = 'Erro ao finalizar pedido. ';
                
                if (error.message.includes('foreign key')) {
                    mensagemErro += 'Problema com IDs de loja ou produtos.';
                } else if (error.message.includes('network')) {
                    mensagemErro += 'Problema de conex√£o. Verifique sua internet.';
                } else {
                    mensagemErro += error.message;
                }
                
                alert(`‚ùå ${mensagemErro}\n\nTente novamente.`);
            }
        }

        // Carregar Pedidos do Cliente
        async function carregarPedidos() {
            try {
                console.log('üîÑ Carregando pedidos...');
                const { data, error } = await supabase
                    .from('pedidos')
                    .select(`
                        *,
                        lojas(nome)
                    `)
                    .eq('cliente_id', clienteId)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('‚ùå Erro ao carregar pedidos:', error);
                    throw error;
                }

                console.log('‚úÖ Pedidos carregados:', data);
                renderizarPedidos(data || []);

            } catch (error) {
                console.error('‚ùå Erro ao carregar pedidos:', error);
                mostrarErro('pedidosLista', 'Erro ao carregar pedidos.');
            }
        }

        function renderizarPedidos(pedidos) {
            const container = document.getElementById('pedidosLista');
            
            if (!pedidos || pedidos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div>üì¶</div>
                        <h3>Nenhum pedido ainda</h3>
                        <p>Seus pedidos aparecer√£o aqui</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = pedidos.map(pedido => `
                <div class="pedido-card">
                    <div class="pedido-header">
                        <div class="pedido-id">Pedido #${pedido.id} - ${pedido.lojas?.nome || 'Loja'}</div>
                        <div class="pedido-status status-${pedido.status}">
                            ${getStatusText(pedido.status)}
                        </div>
                    </div>
                    <div class="pedido-total">Total: R$ ${(pedido.total || 0).toFixed(2)}</div>
                    <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                        üìç ${pedido.endereco_entrega || 'Endere√ßo n√£o informado'}
                    </div>
                    <div style="color: #666; font-size: 0.8rem; margin-top: 5px;">
                        üìÖ ${new Date(pedido.created_at).toLocaleDateString('pt-BR')}
                    </div>
                </div>
            `).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'pendente': '‚è≥ Pendente',
                'aceito': '‚úÖ Aceito',
                'preparando': 'üë®‚Äçüç≥ Preparando',
                'pronto': 'üì¶ Pronto para Entrega',
                'entregue': 'üéâ Entregue',
                'pago': 'üí≥ Pago',
                'cancelado': '‚ùå Cancelado'
            };
            return statusMap[status] || status;
        }

        // Fun√ß√µes auxiliares
        function mostrarFeedback(mensagem) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1001;
                font-weight: 600;
            `;
            toast.textContent = mensagem;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function mostrarErro(elementoId, mensagem) {
            const elemento = document.getElementById(elementoId);
            elemento.innerHTML = `
                <div class="empty-state">
                    <div>‚ùå</div>
                    <h3>Erro</h3>
                    <p>${mensagem}</p>
                </div>
            `;
        }

        function editarPerfil() {
            alert('üîß Funcionalidade de edi√ß√£o de perfil em desenvolvimento...');
        }

        // Filtros e Busca
        function filtrarLojas(categoria) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            if (categoria === 'todos') {
                renderizarLojas();
            } else {
                const lojasFiltradas = lojas.filter(loja => loja.categoria === categoria);
                renderizarLojasFiltradas(lojasFiltradas);
            }
        }

        function renderizarLojasFiltradas(lojasFiltradas) {
            const grid = document.getElementById('lojasGrid');
            
            if (lojasFiltradas.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div>üîç</div>
                        <h3>Nenhuma loja encontrada</h3>
                        <p>Tente outra categoria ou busca</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = lojasFiltradas.map(loja => `
                <div class="loja-card" onclick="abrirModalLoja(${loja.id})">
                    <div class="loja-header">
                        <div class="loja-nome">${loja.nome}</div>
                        <div class="loja-categoria">${getCategoriaIcon(loja.categoria)} ${loja.categoria}</div>
                    </div>
                    <div class="loja-descricao">${loja.descricao || 'Sem descri√ß√£o'}</div>
                    <div class="loja-info">
                        <span>üìç ${loja.endereco || 'Endere√ßo n√£o informado'}</span>
                        <div class="loja-status">
                            <span class="status-aberto">‚óè</span> Aberto agora
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Busca em tempo real
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const termo = e.target.value.toLowerCase().trim();
            
            if (termo === '') {
                renderizarLojas();
                return;
            }

            const lojasFiltradas = lojas.filter(loja => 
                loja.nome.toLowerCase().includes(termo) ||
                loja.descricao?.toLowerCase().includes(termo) ||
                loja.categoria.toLowerCase().includes(termo)
            );

            renderizarLojasFiltradas(lojasFiltradas);
        });

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando dashboard do cliente...');
            carregarLojas();
            carregarPedidos();
        });
    </script>
</body>
    </html>
