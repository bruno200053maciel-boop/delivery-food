<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodFlow - Sistema de Pagamento</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #007bff;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .product-list {
            margin-bottom: 20px;
        }

        .product-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .product-name {
            font-weight: 600;
        }

        .product-price {
            color: #28a745;
            font-weight: 700;
        }

        .total {
            font-size: 1.3rem;
            font-weight: 700;
            text-align: center;
            margin: 20px 0;
            color: #28a745;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            margin: 10px 0;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .payment-container {
            text-align: center;
        }

        .payment-methods {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .payment-method {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .payment-method:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }

        .payment-method.active {
            border-color: #007bff;
            background: #e7f3ff;
        }

        .payment-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .info-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
        }

        .info-box h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
            margin: 10px 0;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        #wallet_container {
            margin: 20px 0;
        }

        .test-cards {
            background: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .test-cards h4 {
            margin-bottom: 10px;
            color: #495057;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .payment-methods {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Cabe√ßalho -->
    <div class="header">
        <h1>üçî FoodFlow</h1>
        <p>Sistema de Pagamento Integrado</p>
    </div>

    <!-- Conte√∫do Principal -->
    <div class="container">
        <!-- Carrinho de Compras -->
        <div class="card">
            <h2>üõí Seu Pedido</h2>
            <div class="product-list" id="productList">
                <div class="product-item">
                    <span class="product-name">Pizza Margherita</span>
                    <span class="product-price">R$ 35,90</span>
                </div>
                <div class="product-item">
                    <span class="product-name">Coca-Cola 2L</span>
                    <span class="product-price">R$ 12,00</span>
                </div>
                <div class="product-item">
                    <span class="product-name">Taxa de Entrega</span>
                    <span class="product-price">R$ 8,50</span>
                </div>
            </div>
            <div class="total" id="totalAmount">Total: R$ 56,40</div>
            
            <div class="info-box">
                <h4>üì¶ Informa√ß√µes de Entrega</h4>
                <p><strong>Endere√ßo:</strong> Rua Exemplo, 123 - S√£o Paulo, SP</p>
                <p><strong>Tempo estimado:</strong> 30-45 minutos</p>
            </div>
            
            <button class="btn btn-primary" onclick="abrirModalPagamento()">
                üí≥ Finalizar Pedido
            </button>
        </div>

        <!-- M√©todos de Pagamento -->
        <div class="card">
            <h2>üîí Pagamento Seguro</h2>
            <div class="payment-container">
                <p>Escolha sua forma de pagamento preferida:</p>
                
                <div class="payment-methods">
                    <div class="payment-method active" onclick="selecionarPagamento('mercado-pago')">
                        <div class="payment-icon">üîµ</div>
                        <div>Mercado Pago</div>
                    </div>
                    <div class="payment-method" onclick="selecionarPagamento('cartao')">
                        <div class="payment-icon">üí≥</div>
                        <div>Cart√£o</div>
                    </div>
                    <div class="payment-method" onclick="selecionarPagamento('pix')">
                        <div class="payment-icon">üì±</div>
                        <div>PIX</div>
                    </div>
                </div>

                <div class="info-box">
                    <h4>üõ°Ô∏è Pagamento 100% Seguro</h4>
                    <p>Todas as transa√ß√µes s√£o criptografadas e protegidas. Seus dados est√£o seguros conosco.</p>
                </div>

                <div id="paymentStatus"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Pagamento -->
    <div class="modal" id="modalPagamento">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üí≥ Finalizar Pagamento</div>
                <button class="close-modal" onclick="fecharModalPagamento()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="payment-container">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üí∞</div>
                    <h3 style="margin-bottom: 10px;">Pagamento do Pedido</h3>
                    <div class="total" id="modalTotal">R$ 56,40</div>
                    
                    <div id="wallet_container"></div>
                    
                    <button class="btn btn-primary" onclick="iniciarPagamentoMercadoPago()">
                        üîµ Pagar com Mercado Pago
                    </button>
                    
                    <button class="btn btn-secondary" onclick="simularPagamentoAprovado()">
                        üß™ Simular Pagamento (Teste)
                    </button>

                    <div class="test-cards">
                        <h4>üí° Cart√µes para Teste (Mercado Pago)</h4>
                        <p><strong>Cart√£o de Cr√©dito:</strong> 5031 4332 1540 6351</p>
                        <p><strong>CVV:</strong> 123</p>
                        <p><strong>Validade:</strong> 11/2025</p>
                        <p><strong>CPF:</strong> 123.456.789-00</p>
                    </div>

                    <div class="info-box">
                        <p><strong>‚ö†Ô∏è Importante:</strong> Em ambiente de produ√ß√£o, estas credenciais devem ser protegidas e armazenadas com seguran√ßa no backend.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üîµ CONFIGURA√á√ÉO MERCADO PAGO (CREDENCIAIS DE PRODU√á√ÉO)
        const MERCADO_PAGO_PUBLIC_KEY = 'APP_USR-3b543a4f-1557-408f-8afd-26f85f56b2e6';
        const MERCADO_PAGO_ACCESS_TOKEN = 'APP_USR-1361591469851554-093022-942bedf8bdfb8';
        
        // Inicializar Mercado Pago
        const mp = new MercadoPago(MERCADO_PAGO_PUBLIC_KEY, {
            locale: 'pt-BR'
        });

        // Estado da aplica√ß√£o
        let carrinho = [
            { id: 1, nome: 'Pizza Margherita', preco: 35.90, quantidade: 1 },
            { id: 2, nome: 'Coca-Cola 2L', preco: 12.00, quantidade: 1 },
            { id: 3, nome: 'Taxa de Entrega', preco: 8.50, quantidade: 1 }
        ];

        let metodoPagamentoSelecionado = 'mercado-pago';

        // Fun√ß√µes de interface
        function selecionarPagamento(metodo) {
            metodoPagamentoSelecionado = metodo;
            
            // Atualizar UI
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('active');
            });
            event.target.closest('.payment-method').classList.add('active');
            
            mostrarStatus(`M√©todo selecionado: ${getNomeMetodo(metodo)}`, 'status-pending');
        }

        function getNomeMetodo(metodo) {
            const metodos = {
                'mercado-pago': 'Mercado Pago',
                'cartao': 'Cart√£o de Cr√©dito',
                'pix': 'PIX'
            };
            return metodos[metodo] || metodo;
        }

        function abrirModalPagamento() {
            document.getElementById('modalPagamento').classList.add('active');
            document.getElementById('modalTotal').textContent = calcularTotal();
            
            // Limpar checkout anterior
            const walletContainer = document.getElementById('wallet_container');
            walletContainer.innerHTML = '';
        }

        function fecharModalPagamento() {
            document.getElementById('modalPagamento').classList.remove('active');
        }

        function calcularTotal() {
            const total = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            return `R$ ${total.toFixed(2)}`;
        }

        function mostrarStatus(mensagem, tipo) {
            const statusDiv = document.getElementById('paymentStatus');
            statusDiv.innerHTML = `<div class="status ${tipo}">${mensagem}</div>`;
        }

        // üîµ SISTEMA DE PAGAMENTO MERCADO PAGO
        async function iniciarPagamentoMercadoPago() {
            try {
                const total = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
                
                console.log('üîÑ Iniciando pagamento Mercado Pago...');
                mostrarStatus('üîÑ Processando pagamento...', 'status-pending');

                // 1. Criar prefer√™ncia de pagamento
                const preferenceData = {
                    items: carrinho.map(item => ({
                        id: item.id.toString(),
                        title: item.nome,
                        description: `Quantidade: ${item.quantidade}`,
                        quantity: item.quantidade,
                        currency_id: 'BRL',
                        unit_price: parseFloat(item.preco)
                    })),
                    back_urls: {
                        success: window.location.href,
                        failure: window.location.href,
                        pending: window.location.href
                    },
                    auto_return: 'approved',
                    statement_descriptor: 'FoodFlow',
                    external_reference: `pedido_${Date.now()}`,
                    notification_url: 'https://webhook.site/your-webhook' // Configure seu webhook
                };

                console.log('üì¶ Dados da prefer√™ncia:', preferenceData);

                // 2. Fazer requisi√ß√£o para criar a prefer√™ncia
                const response = await fetch('https://api.mercadopago.com/checkout/preferences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${MERCADO_PAGO_ACCESS_TOKEN}`
                    },
                    body: JSON.stringify(preferenceData)
                });

                if (!response.ok) {
                    throw new Error(`Erro na API Mercado Pago: ${response.status}`);
                }

                const preference = await response.json();
                console.log('‚úÖ Prefer√™ncia criada:', preference);

                // 3. Inicializar checkout
                const walletContainer = document.getElementById('wallet_container');
                walletContainer.innerHTML = '';

                const bricksBuilder = mp.bricks();

                await bricksBuilder.create("wallet", "wallet_container", {
                    initialization: {
                        preferenceId: preference.id,
                    },
                    customization: {
                        texts: {
                            valueProp: 'smart_option',
                        },
                    },
                });

                mostrarStatus('üîµ Checkout do Mercado Pago carregado! Preencha os dados de pagamento.', 'status-pending');

            } catch (error) {
                console.error('‚ùå Erro no pagamento Mercado Pago:', error);
                mostrarStatus(`‚ùå Erro: ${error.message}`, 'status-error');
                
                // Fallback para simula√ß√£o
                setTimeout(() => {
                    mostrarStatus('üîÑ Tentando m√©todo alternativo...', 'status-pending');
                    simularPagamentoAprovado();
                }, 3000);
            }
        }

        // üîµ SIMULA√á√ÉO DE PAGAMENTO (PARA TESTES)
        async function simularPagamentoAprovado() {
            try {
                mostrarStatus('üîÑ Processando simula√ß√£o de pagamento...', 'status-pending');
                
                // Simular delay de processamento
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Simular dados do pagamento
                const pagamento = {
                    id: Math.random().toString(36).substr(2, 9),
                    status: 'approved',
                    total: calcularTotal(),
                    data: new Date().toLocaleString('pt-BR')
                };

                // Simular salvamento no banco de dados
                await simularSalvamentoPedido(pagamento);
                
                mostrarStatus(`üéâ Pagamento aprovado! ID: ${pagamento.id}`, 'status-success');
                
                // Limpar carrinho
                carrinho = [];
                document.getElementById('productList').innerHTML = '<div class="product-item"><span>Pedido finalizado com sucesso!</span></div>';
                document.getElementById('totalAmount').textContent = 'Total: R$ 0,00';
                
                // Fechar modal ap√≥s sucesso
                setTimeout(() => {
                    fecharModalPagamento();
                }, 3000);

            } catch (error) {
                console.error('‚ùå Erro na simula√ß√£o:', error);
                mostrarStatus(`‚ùå Erro na simula√ß√£o: ${error.message}`, 'status-error');
            }
        }

        // üîµ SIMULAR SALVAMENTO NO BANCO DE DADOS
        async function simularSalvamentoPedido(pagamento) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    // Simular sucesso 90% das vezes
                    if (Math.random() > 0.1) {
                        console.log('‚úÖ Pedido salvo no banco de dados:', pagamento);
                        resolve(pagamento);
                    } else {
                        reject(new Error('Falha ao salvar pedido no banco de dados'));
                    }
                }, 1000);
            });
        }

        // üîµ WEBHOOK HANDLER (EXEMPLO)
        async function handleWebhook(data) {
            // Esta fun√ß√£o seria chamada pelo webhook do Mercado Pago
            console.log('üì® Webhook recebido:', data);
            
            if (data.type === 'payment') {
                const paymentId = data.data.id;
                
                // Buscar detalhes do pagamento
                const response = await fetch(`https://api.mercadopago.com/v1/payments/${paymentId}`, {
                    headers: {
                        'Authorization': `Bearer ${MERCADO_PAGO_ACCESS_TOKEN}`
                    }
                });
                
                const payment = await response.json();
                
                if (payment.status === 'approved') {
                    // Atualizar pedido como pago no banco de dados
                    console.log('‚úÖ Pagamento confirmado via webhook:', payment);
                    await atualizarStatusPedido(payment.external_reference, 'pago');
                }
            }
        }

        // üîµ ATUALIZAR STATUS DO PEDIDO
        async function atualizarStatusPedido(pedidoId, status) {
            // Implementar l√≥gica para atualizar pedido no banco de dados
            console.log(`üîÑ Atualizando pedido ${pedidoId} para status: ${status}`);
            
            // Exemplo de implementa√ß√£o com Supabase
            /*
            const { data, error } = await supabase
                .from('pedidos')
                .update({ status: status })
                .eq('id', pedidoId);
            */
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Sistema de pagamento FoodFlow inicializado');
            console.log('üîë Chave p√∫blica:', MERCADO_PAGO_PUBLIC_KEY);
            console.log('üîê Token de acesso:', MERCADO_PAGO_ACCESS_TOKEN ? '***' + MERCADO_PAGO_ACCESS_TOKEN.slice(-4) : 'N√£o definido');
            
            // Verificar se as credenciais est√£o configuradas
            if (!MERCADO_PAGO_PUBLIC_KEY || !MERCADO_PAGO_ACCESS_TOKEN) {
                console.error('‚ùå Credenciais do Mercado Pago n√£o configuradas');
                mostrarStatus('‚ùå Sistema de pagamento n√£o configurado', 'status-error');
            } else {
                console.log('‚úÖ Credenciais do Mercado Pago configuradas');
            }
        });

        // üîµ EXEMPLO DE INTEGRA√á√ÉO COM SUPABASE (COMENTADO)
        /*
        const supabaseUrl = 'https://lsskaqudqvppfwfoxsih.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxzc2thcXVkcXZwcGZ3Zm94c2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDIxMzEsImV4cCI6MjA3NDgxODEzMX0.-M8bTf68RVY_kVrVyZ_BEfROLOrykauRYJzS2OnH6Fo';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        async function salvarPedidoNoBanco(pedidoData) {
            try {
                const { data, error } = await supabase
                    .from('pedidos')
                    .insert([{
                        cliente_id: pedidoData.clienteId,
                        loja_id: pedidoData.lojaId,
                        total: pedidoData.total,
                        status: 'pendente',
                        endereco_entrega: pedidoData.endereco,
                        metodo_pagamento: pedidoData.metodoPagamento,
                        pagamento_id: pedidoData.pagamentoId
                    }])
                    .select();

                if (error) throw error;
                return data[0].id;

            } catch (error) {
                console.error('Erro ao salvar pedido:', error);
                throw error;
            }
        }
        */
    </script>
</body>
                    </html>
